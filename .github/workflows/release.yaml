name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  release-jar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v5

      - name: release jar
        run: |
          VERSION=$(echo ${GITHUB_REF} | sed -e "s/refs\/tags\/v//")
          gradle publishToSonatype closeAndReleaseSonatypeStagingRepository --stacktrace -P version=$VERSION
        env:
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.ORG_GRADLE_PROJECT_SONATYPEUSERNAME }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.ORG_GRADLE_PROJECT_SONATYPEPASSWORD }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGKEY }}
  release-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org/'

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v5

      - name: Build JS Package
        run: ./gradlew jsNodeProductionLibraryDistribution

      - name: Publish commons-js
        working-directory: ./commons-js/build/dist/js/productionLibrary
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          MAJOR=${VERSION%%.*}

          # Get the latest version from npm to determine if this should be tagged as 'latest'
          LATEST_VERSION=$(npm view @attocash/commons-js version 2>/dev/null || echo "0.0.0")
          LATEST_MAJOR=${LATEST_VERSION%%.*}

          if [ "$MAJOR" -ge "$LATEST_MAJOR" ]; then
            TAG="latest"
          else
            TAG="v${MAJOR}-line"
          fi

          echo "Publishing version $VERSION with tag $TAG"

          npm version "$VERSION"
          npm publish --access public --tag "$TAG"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish commons-test
        working-directory: ./commons-test/build/dist/js/productionLibrary
        run: |
          VERSION=$(echo ${GITHUB_REF} | sed -e "s/refs\/tags\/v//")
          npm version "$VERSION"
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
